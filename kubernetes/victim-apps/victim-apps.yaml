# ============================================================================
# AKS Adversary Lab - Victim Applications
# Deploy to 'victim' namespace
# Intentionally vulnerable for attack simulation
# ============================================================================

---
# ── DVWA (Damn Vulnerable Web Application) ─────────────────────────────────
# Techniques: T1190 (Exploit Public-Facing Application)
# Web app with SQL injection, XSS, command injection, file upload vulns
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dvwa
  namespace: victim
  labels:
    app: dvwa
    adversary-lab/role: "vulnerable-app"
    adversary-lab/expose: "web"
  annotations:
    adversary-lab/mitre-techniques: "T1190"
    adversary-lab/description: "Intentionally vulnerable web app for exploitation testing"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dvwa
  template:
    metadata:
      labels:
        app: dvwa
        adversary-lab/expose: "web"
    spec:
      containers:
        - name: dvwa
          image: docker.io/vulnerables/web-dvwa:latest
          ports:
            - containerPort: 80
              name: http
          env:
            - name: MYSQL_HOSTNAME
              value: "127.0.0.1"
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"

---
apiVersion: v1
kind: Service
metadata:
  name: dvwa
  namespace: victim
  labels:
    app: dvwa
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 80
      name: http
  selector:
    app: dvwa

---
# ── Vulnerable API with Secrets in Environment ────────────────────────────
# Techniques: T1552.001 (Credentials In Files), T1528 (Steal App Access Token)
# Intentionally stores secrets in env vars and mounts SA token

apiVersion: apps/v1
kind: Deployment
metadata:
  name: vulnerable-api
  namespace: victim
  labels:
    app: vulnerable-api
    adversary-lab/role: "vulnerable-app"
    adversary-lab/expose: "web"
  annotations:
    adversary-lab/mitre-techniques: "T1552.001,T1528"
    adversary-lab/description: "API with secrets in env vars — DO NOT replicate in production"
    adversary-lab/warning: "INTENTIONALLY MISCONFIGURED"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vulnerable-api
  template:
    metadata:
      labels:
        app: vulnerable-api
        adversary-lab/expose: "web"
    spec:
      # automountServiceAccountToken defaults to true — intentionally left
      # This allows T1528 (steal SA token from /var/run/secrets/)
      containers:
        - name: api
          image: docker.io/hashicorp/http-echo:latest
          args:
            - "-text=Vulnerable API - Check /var/run/secrets/ for SA token"
            - "-listen=:8080"
          ports:
            - containerPort: 8080
              name: http
          env:
            # INTENTIONALLY INSECURE — secrets in environment variables
            # This is the exact misconfiguration T1552.001 exploits
            - name: DATABASE_PASSWORD
              value: "SuperSecretDBPassword123!"
            - name: API_KEY
              value: "sk-lab-FAKE-api-key-for-detection-testing-only"
            - name: AZURE_CLIENT_SECRET
              value: "lab-fake-client-secret-00000000"
          resources:
            requests:
              cpu: "50m"
              memory: "32Mi"
            limits:
              cpu: "200m"
              memory: "128Mi"

---
apiVersion: v1
kind: Service
metadata:
  name: vulnerable-api
  namespace: victim
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      name: http
  selector:
    app: vulnerable-api

---
# ── Kubernetes Secret (for T1552.007 testing) ─────────────────────────────
# Intentionally created secret that red team tools will try to enumerate

apiVersion: v1
kind: Secret
metadata:
  name: database-credentials
  namespace: victim
  labels:
    adversary-lab/role: "target-secret"
  annotations:
    adversary-lab/mitre-techniques: "T1552.007"
    adversary-lab/description: "Target secret for credential access testing"
type: Opaque
stringData:
  username: "db_admin"
  password: "VictimDBPassword456!"
  connection-string: "Server=db.victim.svc;Database=app;User=db_admin;Password=VictimDBPassword456!"

---
# ── CronJob (for T1053.007 testing) ───────────────────────────────────────
# Legitimate-looking CronJob that the red team should detect/imitate

apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-job
  namespace: victim
  labels:
    app: backup
    adversary-lab/role: "legitimate-workload"
  annotations:
    adversary-lab/mitre-techniques: "T1053.007"
    adversary-lab/description: "Legitimate CronJob — red team will create similar malicious ones"
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup
              image: docker.io/busybox:latest
              command: ["/bin/sh", "-c", "echo 'Running scheduled backup...' && sleep 5 && echo 'Backup complete'"]
              resources:
                requests:
                  cpu: "50m"
                  memory: "32Mi"
                limits:
                  cpu: "200m"
                  memory: "128Mi"
          restartPolicy: OnFailure
