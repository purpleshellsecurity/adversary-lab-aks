# ============================================================================
# AKS Adversary Lab - Falco Helm Values
# Deploy: helm install falco falcosecurity/falco -n monitoring -f falco-values.yaml
#
# Falco provides eBPF-based syscall monitoring mapped to MITRE ATT&CK.
# 46+ built-in container rules detect:
#   T1609 (exec into container)
#   T1611 (container escape — mount namespace changes)
#   T1552.001 (read sensitive files — /etc/shadow, SA tokens)
#   T1070 (log deletion/tampering)
#   T1562.001 (security tool modification)
#   T1496 (crypto mining processes)
# ============================================================================

driver:
  kind: modern_ebpf  # Use modern eBPF driver for AKS compatibility

collectors:
  kubernetes:
    enabled: true

falco:
  grpc:
    enabled: true
  grpc_output:
    enabled: true
  json_output: true
  json_include_output_property: true
  log_stderr: true
  log_syslog: false
  log_level: info

  rules_files:
    - /etc/falco/falco_rules.yaml
    - /etc/falco/falco_rules.local.yaml
    - /etc/falco/rules.d

# Enable Falcosidekick for alert forwarding
falcosidekick:
  enabled: true
  config:
    # Forward alerts to stdout for Container Insights pickup
    debug: true

# Tolerate system pool taints so Falco runs on all nodes
tolerations:
  - key: "CriticalAddonsOnly"
    operator: "Exists"
    effect: "NoSchedule"

# Custom rules for adversary lab detections
customRules:
  adversary-lab-rules.yaml: |-
    # ── T1552.001: Read Sensitive Files in Container ───────────────────
    - rule: Read ServiceAccount Token in Container
      desc: Detects processes reading the mounted SA token inside a container (MITRE T1528)
      condition: >
        open_read and
        container and
        (fd.name = "/var/run/secrets/kubernetes.io/serviceaccount/token" or
         fd.name = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt")
      output: >
        SA token read inside container
        (user=%user.name command=%proc.cmdline file=%fd.name
         container=%container.name pod=%k8s.pod.name ns=%k8s.ns.name
         image=%container.image.repository:%container.image.tag)
      priority: WARNING
      tags: [mitre_credential_access, T1528]

    # ── T1610: Deploy Privileged Container ──────────────────────────────
    # Note: Privileged container detection is handled by built-in Falco rules
    # ("Launch Privileged Container") — this rule catches nsenter escape attempts
    - rule: Container Escape via nsenter
      desc: Detects nsenter execution which may indicate container escape (MITRE T1611)
      condition: >
        spawned_process and
        container and
        proc.name = nsenter
      output: >
        nsenter executed in container — possible escape attempt
        (user=%user.name command=%proc.cmdline
         container=%container.name pod=%k8s.pod.name ns=%k8s.ns.name
         image=%container.image.repository:%container.image.tag)
      priority: CRITICAL
      tags: [mitre_privilege_escalation, T1611]

    # ── T1496: Cryptocurrency Mining ────────────────────────────────────
    - rule: Crypto Mining Process Detected
      desc: Detects known crypto mining binaries or pool connections (MITRE T1496.001)
      condition: >
        spawned_process and
        container and
        (proc.name in (xmrig, minerd, minergate, cpuminer) or
         proc.cmdline contains "stratum+tcp" or
         proc.cmdline contains "pool.minexmr" or
         proc.cmdline contains "cryptonight")
      output: >
        Crypto mining activity detected
        (process=%proc.name command=%proc.cmdline
         container=%container.name pod=%k8s.pod.name ns=%k8s.ns.name
         image=%container.image.repository:%container.image.tag)
      priority: CRITICAL
      tags: [mitre_impact, T1496, T1496.001]

    # ── T1059: Reverse Shell Detection ──────────────────────────────────
    - rule: Reverse Shell in Container
      desc: Detects common reverse shell patterns in containers
      condition: >
        spawned_process and
        container and
        (proc.cmdline contains "/dev/tcp/" or
         proc.cmdline contains "bash -i" or
         (proc.name in (nc, ncat, nmap) and proc.cmdline contains "-e"))
      output: >
        Reverse shell detected in container
        (process=%proc.name command=%proc.cmdline
         container=%container.name pod=%k8s.pod.name ns=%k8s.ns.name
         image=%container.image.repository:%container.image.tag)
      priority: CRITICAL
      tags: [mitre_execution, T1059]
