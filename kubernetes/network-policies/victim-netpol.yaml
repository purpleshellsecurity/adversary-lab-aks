# ============================================================================
# Victim Namespace Network Policies
# Default deny all traffic, then selectively allow required flows
# Uses Cilium-native CiliumNetworkPolicy for L7 inspection
# ============================================================================

---
# Default deny ALL ingress and egress in victim namespace
# This is the foundation — every allowed flow must be explicitly permitted
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: victim
  labels:
    adversary-lab/policy-type: "baseline"
  annotations:
    adversary-lab/mitre: "T1046 mitigation — prevents unrestricted network scanning"
spec:
  podSelector: {}  # Applies to ALL pods in victim namespace
  policyTypes:
    - Ingress
    - Egress

---
# Allow victim pods to resolve DNS (required for any external communication)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: victim
  labels:
    adversary-lab/policy-type: "essential"
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# Allow ingress to victim web apps from external (for testing T1190)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-web-ingress
  namespace: victim
  labels:
    adversary-lab/policy-type: "service"
spec:
  podSelector:
    matchLabels:
      adversary-lab/expose: "web"
  policyTypes:
    - Ingress
  ingress:
    - ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 8080

---
# Allow monitoring namespace to scrape victim pods (Prometheus)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring-scrape
  namespace: victim
  labels:
    adversary-lab/policy-type: "monitoring"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              adversary-lab/role: "blue-team"
      ports:
        - protocol: TCP
          port: 9090  # Prometheus metrics
        - protocol: TCP
          port: 8080  # App metrics

---
# DENY ingress from attacker namespace (the attacker must bypass this)
# This policy creates the detection opportunity for T1550.001 lateral movement
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-attacker-ingress
  namespace: victim
  labels:
    adversary-lab/policy-type: "security"
  annotations:
    adversary-lab/mitre: "T1550.001 detection — lateral movement from attacker to victim should trigger alerts"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchExpressions:
              - key: adversary-lab/role
                operator: NotIn
                values:
                  - "red-team"
